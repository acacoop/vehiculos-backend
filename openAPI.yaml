openapi: 3.0.3
info:
  title: Vehicle Management API
  version: 2.0.0
  description: |
    Secure and scalable API for managing users, vehicles, assignments, and maintenance operations.

    ## Features
    - RESTful endpoints with consistent plural naming
    - Comprehensive error handling
    - Input validation and sanitization
    - Pagination support
    - Security headers and rate limiting

    ## Authentication
    This API is protected with Bearer JWT tokens issued by Microsoft Entra ID (Azure AD).
    Send requests with an Authorization header: `Authorization: Bearer <access_token>`.

servers:
  - url: http://localhost:3000
    description: Development server
  - url: https://app-vehiculos-api-prod.azurewebsites.net
    description: Production server
  - url: https://app-vehiculos-api-test.azurewebsites.net
    description: Test server

paths:
  # HEALTH CHECK
  /health:
    get:
      summary: Health check endpoint
      tags: [System]
      security: [] # Public endpoint; no auth required
      responses:
        "200":
          description: API is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  message:
                    type: string
                    example: "API is healthy"
                  timestamp:
                    type: string
                    format: date-time
                  uptime:
                    type: number

  /me:
    get:
      summary: Get current authenticated user
      description: |
        Returns the local user mapped to the bearer token.

        Dev testing:
        When `AUTH_BYPASS=true` on the server, you can impersonate a user without a Bearer token by sending the optional header below.
        - `x-dev-impersonate`: email or entraId of a user (seeded by sample data)
      tags: [Users]
      parameters:
        - $ref: "#/components/parameters/DevImpersonateHeader"
      responses:
        "200":
          description: Current user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "401":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"

  # USERS
  /users:
    get:
      summary: Get all users with pagination and search
      description: |
        Get users with optional search and filters.

        **Search:** `search` - Search across firstName, lastName, email, and cuit

        **Filters:**
        - `email` - Exact match by email
        - `cuit` - Exact match by CUIT
        - `firstName` - Partial match by first name
        - `lastName` - Partial match by last name
        - `active` - Filter by active status (true/false)
      tags: [Users]
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/LimitParam"
        - $ref: "#/components/parameters/SearchParam"
        - name: email
          in: query
          description: Exact match by email
          schema:
            type: string
            format: email
        - name: cuit
          in: query
          description: Exact match by CUIT
          schema:
            type: string
            pattern: "^[0-9]{11}$"
        - name: firstName
          in: query
          description: Partial match by first name
          schema:
            type: string
        - name: lastName
          in: query
          description: Partial match by last name
          schema:
            type: string
        - name: active
          in: query
          description: Filter by active status
          schema:
            type: boolean
      responses:
        "200":
          description: List of users
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserListResponse"
    post:
      summary: Create a new user
      tags: [Users]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserInput"
      responses:
        "201":
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          $ref: "#/components/responses/Conflict"

  /users/{id}:
    get:
      summary: Get user by ID
      tags: [Users]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: User found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "404":
          $ref: "#/components/responses/NotFound"
    patch:
      summary: Update user
      tags: [Users]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserUpdateInput"
      responses:
        "200":
          description: User updated successfully
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
    delete:
      summary: Delete user
      tags: [Users]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: User deleted successfully
        "404":
          description: User not found

  /users/{id}/activate:
    post:
      summary: Activate user
      description: Activate a deactivated user
      tags: [Users]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: User activated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "404":
          description: User not found
        "409":
          description: User is already active
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/ProblemDetails"

  /users/{id}/deactivate:
    post:
      summary: Deactivate user
      description: Deactivate an active user (soft delete)
      tags: [Users]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: User deactivated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "404":
          description: User not found
        "409":
          description: User is already inactive
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/ProblemDetails"

  # VEHICLES
  /vehicles:
    get:
      summary: Get all vehicles with pagination and search
      description: |
        Get vehicles with optional search and filters.

        **Search:** `search` - Search across licensePlate, chassisNumber, brand name, and model name

        **Filters:**
        - `licensePlate` - Exact match by license plate
        - `brandId` - Exact match by brand UUID
        - `modelId` - Exact match by model UUID
        - `year` - Exact match by year
        - `minYear` - Minimum year (inclusive) for year range filter
        - `maxYear` - Maximum year (inclusive) for year range filter
        - `fuelType` - Exact match by fuel type
        - `minKilometers` - Minimum kilometers (inclusive) based on latest kilometers log
        - `maxKilometers` - Maximum kilometers (exclusive) based on latest kilometers log
        - `registrationDateFrom` - Minimum registration date (inclusive) for filtering by date range
        - `registrationDateTo` - Maximum registration date (inclusive) for filtering by date range
      tags: [Vehicles]
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/LimitParam"
        - $ref: "#/components/parameters/SearchParam"
        - name: licensePlate
          in: query
          description: Exact match by license plate
          schema:
            type: string
            pattern: '^[A-Z]{2,3}-?\d{3,4}[A-Z]{0,2}$'
        - name: brandId
          in: query
          description: Exact match by brand UUID
          schema:
            type: string
            format: uuid
        - name: modelId
          in: query
          description: Exact match by model UUID
          schema:
            type: string
            format: uuid
        - name: year
          in: query
          description: Exact match by year
          schema:
            type: integer
            minimum: 1900
            maximum: 2030
        - name: minYear
          in: query
          description: Minimum year (inclusive) for filtering by age range
          schema:
            type: integer
            minimum: 1900
            maximum: 2030
        - name: maxYear
          in: query
          description: Maximum year (inclusive) for filtering by age range
          schema:
            type: integer
            minimum: 1900
            maximum: 2030
        - name: fuelType
          in: query
          description: Exact match by fuel type (e.g., Nafta, Diésel, Híbrido, Eléctrico)
          schema:
            type: string
        - name: minKilometers
          in: query
          description: Minimum kilometers (inclusive) based on latest kilometers log
          schema:
            type: integer
            minimum: 0
        - name: maxKilometers
          in: query
          description: Maximum kilometers (exclusive) based on latest kilometers log
          schema:
            type: integer
            minimum: 0
        - name: registrationDateFrom
          in: query
          description: Minimum registration date (inclusive) for filtering by date range
          schema:
            type: string
            format: date
        - name: registrationDateTo
          in: query
          description: Maximum registration date (inclusive) for filtering by date range
          schema:
            type: string
            format: date
      responses:
        "200":
          description: List of vehicles
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VehicleListResponse"
    post:
      summary: Create a new vehicle
      tags: [Vehicles]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VehicleInput"
      responses:
        "201":
          description: Vehicle created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VehicleResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          $ref: "#/components/responses/Conflict"

  /vehicles/{id}:
    get:
      summary: Get vehicle by ID
      tags: [Vehicles]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Vehicle found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VehicleResponse"
        "404":
          description: Vehicle not found
    patch:
      summary: Update vehicle
      tags: [Vehicles]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VehicleUpdateInput"
      responses:
        "200":
          description: Vehicle updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VehicleResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
    delete:
      summary: Delete vehicle
      tags: [Vehicles]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Vehicle deleted successfully
        "404":
          description: Vehicle not found

  # VEHICLE KILOMETERS LOGS
  /vehicle-kilometersLogs:
    get:
      summary: Get all vehicle kilometers logs with pagination and search
      description: |
        Get all kilometer logs across all vehicles with optional search and filters.

        **Search:** `search` - Search across vehicle licensePlate, chassisNumber, user firstName, lastName, email

        **Filters:**
        - `vehicleId` - Filter by specific vehicle UUID
        - `userId` - Filter by specific user UUID
        - `fromDate` - Filter logs from this date onwards (ISO 8601)
        - `toDate` - Filter logs up to this date (ISO 8601)
        - `minKilometers` - Filter logs with kilometers >= this value
        - `maxKilometers` - Filter logs with kilometers <= this value
      tags: [Vehicle Kilometers Logs]
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/LimitParam"
        - $ref: "#/components/parameters/SearchParam"
        - name: vehicleId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by vehicle ID
        - name: userId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by user ID
        - name: fromDate
          in: query
          schema:
            type: string
            format: date-time
          description: Filter logs from this date onwards
        - name: toDate
          in: query
          schema:
            type: string
            format: date-time
          description: Filter logs up to this date
        - name: minKilometers
          in: query
          schema:
            type: integer
            minimum: 0
          description: Filter logs with kilometers greater than or equal to this value
        - name: maxKilometers
          in: query
          schema:
            type: integer
            minimum: 0
          description: Filter logs with kilometers less than or equal to this value
      responses:
        "200":
          description: List of kilometer logs retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VehicleKilometersLogListResponse"
        "500":
          $ref: "#/components/responses/InternalServerError"
    post:
      summary: Create a new kilometer log
      description: |
        Create a new kilometer log entry. The kilometers value must be chronologically valid:
        - Must be >= the previous reading (if exists)
        - Must be <= the next reading (if exists)

        Returns 422 if the kilometers value violates chronological order.
      tags: [Vehicle Kilometers Logs]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VehicleKilometersLogCreateInput"
            examples:
              valid:
                summary: Valid log entry
                value:
                  vehicleId: "650e8400-e29b-41d4-a716-446655440001"
                  userId: "550e8400-e29b-41d4-a716-446655440000"
                  date: "2025-02-05T09:00:00Z"
                  kilometers: 48500
              invalid:
                summary: Invalid log (km less than previous)
                value:
                  vehicleId: "650e8400-e29b-41d4-a716-446655440001"
                  userId: "550e8400-e29b-41d4-a716-446655440000"
                  date: "2025-02-05T09:00:00Z"
                  kilometers: 40000
      responses:
        "201":
          description: Kilometer log created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VehicleKilometersLogResponse"
        "422":
          description: Invalid kilometers value (out of chronological order)
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/ProblemDetails"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          description: Vehicle or User not found
        "500":
          $ref: "#/components/responses/InternalServerError"

  /vehicle-kilometersLogs/{id}:
    get:
      summary: Get kilometer log by ID
      tags: [Vehicle Kilometers Logs]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Kilometer log found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VehicleKilometersLogResponse"
        "404":
          $ref: "#/components/responses/NotFound"
    patch:
      summary: Update kilometer log
      description: |
        Update an existing kilometer log. The updated kilometers value must maintain chronological order:
        - Must be >= the previous reading (excluding this record)
        - Must be <= the next reading (excluding this record)

        Returns 422 if the new kilometers value violates chronological order.
      tags: [Vehicle Kilometers Logs]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VehicleKilometersLogUpdateInput"
      responses:
        "200":
          description: Kilometer log updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VehicleKilometersLogResponse"
        "422":
          description: Invalid kilometers value (out of chronological order)
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/ProblemDetails"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
    delete:
      summary: Delete kilometer log
      tags: [Vehicle Kilometers Logs]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Kilometer log deleted successfully
        "404":
          description: Kilometer log not found

  # RESERVATIONS
  /reservations:
    get:
      summary: Get all reservations with optional filters
      description: |
        Get all reservations with optional search and filters.

        **Search:** `search` - Search across user firstName, lastName, email, cuit, and vehicle licensePlate, chassisNumber, brand name, model name

        **Filters:**
        - `userId` - Filter by specific user ID
        - `vehicleId` - Filter by specific vehicle ID
        - `startDate` - Filter reservations active on or after this date (reservations that haven't ended before this date)
        - `endDate` - Filter reservations active on or before this date (reservations that haven't started after this date)

        **Date Range Overlap:** When both `startDate` and `endDate` are provided, returns reservations that overlap with the date range [startDate, endDate]. A reservation overlaps if it hasn't ended before the filter's startDate AND hasn't started after the filter's endDate.
      tags: [Reservations]
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/LimitParam"
        - $ref: "#/components/parameters/SearchParam"
        - name: userId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by user ID
        - name: vehicleId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by vehicle ID
        - name: startDate
          in: query
          schema:
            type: string
            format: date
          description: Filter reservations active on or after this date (finds reservations where endDate >= this value)
        - name: endDate
          in: query
          schema:
            type: string
            format: date
          description: Filter reservations active on or before this date (finds reservations where startDate <= this value)
      responses:
        "200":
          description: List of reservations retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReservationListResponse"
        "500":
          $ref: "#/components/responses/InternalServerError"
    post:
      summary: Create a new reservation
      tags: [Reservations]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ReservationInput"
      responses:
        "201":
          description: Reservation created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReservationResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /reservations/{id}:
    get:
      summary: Get reservation by ID
      tags: [Reservations]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Reservation found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReservationResponse"
        "404":
          $ref: "#/components/responses/NotFound"
    patch:
      summary: Update reservation
      tags: [Reservations]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ReservationUpdateInput"
      responses:
        "200":
          description: Reservation updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReservationResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
    delete:
      summary: Delete reservation
      tags: [Reservations]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Reservation deleted successfully
        "404":
          description: Reservation not found

  # ASSIGNMENTS
  /assignments:
    get:
      summary: Get all vehicle assignments with optional filters
      description: |
        Get all vehicle assignments with optional search and filters.

        **Search:** `search` - Search across user firstName, lastName, email, and vehicle licensePlate, chassisNumber

        **Filters:**
        - `userId` - Filter by specific user ID
        - `vehicleId` - Filter by specific vehicle ID
        - `date` - Filter assignments active on specific date (YYYY-MM-DD)
      tags: [Assignments]
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/LimitParam"
        - $ref: "#/components/parameters/SearchParam"
        - name: userId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by user ID
        - name: vehicleId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by vehicle ID
        - name: active
          in: query
          schema:
            type: boolean
          description: Filter assignments active at current time
      responses:
        "200":
          description: List of assignments retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AssignmentListResponse"
        "500":
          $ref: "#/components/responses/InternalServerError"
    post:
      summary: Create a new vehicle assignment
      tags: [Assignments]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AssignmentInput"
      responses:
        "201":
          description: Assignment created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AssignmentResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /assignments/{id}/finish:
    patch:
      summary: Finish a vehicle assignment
      description: Mark a vehicle assignment as finished by setting an end date
      tags: [Assignments]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                endDate:
                  type: string
                  format: date-time
                  description: Optional end date (defaults to now)
      responses:
        "200":
          description: Assignment finished successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AssignmentResponse"
        "404":
          description: Assignment not found

  # MAINTENANCE CATEGORIES
  /maintenance/categories:
    get:
      summary: Get all maintenance categories with optional filters
      description: |
        Get all maintenance categories with optional search and filters.

        **Search:** `search` - Search by category name

        **Filters:**
        - `name` - Partial match by category name
      tags: [Maintenance]
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/LimitParam"
        - $ref: "#/components/parameters/SearchParam"
        - name: name
          in: query
          schema:
            type: string
          description: Filter by category name
      responses:
        "200":
          description: List of maintenance categories retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaintenanceCategoryListResponse"
        "500":
          $ref: "#/components/responses/InternalServerError"
    post:
      summary: Create a new maintenance category
      tags: [Maintenance]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MaintenanceCategoryInput"
      responses:
        "201":
          description: Maintenance category created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaintenanceCategoryResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /maintenance/categories/{id}:
    get:
      summary: Get maintenance category by ID
      tags: [Maintenance]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Maintenance category retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaintenanceCategoryResponse"
        "404":
          $ref: "#/components/responses/NotFound"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"
    patch:
      summary: Update maintenance category
      tags: [Maintenance]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MaintenanceCategoryInput"
      responses:
        "200":
          description: Maintenance category updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaintenanceCategoryResponse"
        "404":
          $ref: "#/components/responses/NotFound"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"
    delete:
      summary: Delete maintenance category
      tags: [Maintenance]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Maintenance category deleted successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponse"
        "404":
          $ref: "#/components/responses/NotFound"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # MAINTENANCE POSIBLES
  /maintenance/posibles:
    get:
      summary: Get all possible maintenance types with optional filters
      description: |
        Get all possible maintenance types with optional search and filters.

        **Search:** `search` - Search across maintenance name and category name

        **Filters:**
        - `name` - Partial match by maintenance name
        - `categoryId` - Filter by maintenance category ID
      tags: [Maintenance]
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/LimitParam"
        - $ref: "#/components/parameters/SearchParam"
        - name: name
          in: query
          schema:
            type: string
          description: Filter by maintenance name
        - name: categoryId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by maintenance category ID
      responses:
        "200":
          description: List of possible maintenance types retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaintenanceListResponse"
        "500":
          $ref: "#/components/responses/InternalServerError"
    post:
      summary: Create a new maintenance type
      tags: [Maintenance]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MaintenanceInput"
      responses:
        "201":
          description: Maintenance type created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaintenanceResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /maintenance/posibles/{id}:
    get:
      summary: Get maintenance type by ID
      tags: [Maintenance]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Maintenance type retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaintenanceResponse"
        "404":
          $ref: "#/components/responses/NotFound"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"
    patch:
      summary: Update maintenance type
      tags: [Maintenance]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MaintenanceInput"
      responses:
        "200":
          description: Maintenance type updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaintenanceResponse"
        "404":
          $ref: "#/components/responses/NotFound"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"
    delete:
      summary: Delete maintenance type
      tags: [Maintenance]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Maintenance type deleted successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponse"
        "404":
          $ref: "#/components/responses/NotFound"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # MAINTENANCE REQUIREMENTS
  /maintenance/requirements:
    get:
      summary: Get all maintenance requirements with optional filters
      description: |
        Get all maintenance requirements (vehicle-maintenance temporal assignments) with optional search and filters.

        **Search:** `search` - Search across vehicle licensePlate, maintenance name, and category name

        **Filters:**
        - `vehicleId` - Filter by vehicle ID
        - `maintenanceId` - Filter by maintenance type ID
        - `active` - Filter by active status (requirements currently active)
      tags: [Maintenance]
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/LimitParam"
        - $ref: "#/components/parameters/SearchParam"
        - name: vehicleId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by vehicle ID
        - name: maintenanceId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by maintenance type ID
        - name: active
          in: query
          schema:
            type: boolean
          description: Filter by active status
      responses:
        "200":
          description: List of maintenance requirements retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaintenanceRequirementListResponse"
        "500":
          $ref: "#/components/responses/InternalServerError"
    post:
      summary: Create a new maintenance requirement
      description: |
        Create a new maintenance requirement for a vehicle. 

        **Overlap Validation:** The system prevents overlapping date ranges for the same vehicle-maintenance pair.
        If a requirement already exists with overlapping dates, the API will return a 409 Conflict error.
      tags: [Maintenance]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MaintenanceRequirementInput"
      responses:
        "201":
          description: Maintenance requirement created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaintenanceRequirementResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          description: Overlapping requirement exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /maintenance/requirements/{id}:
    get:
      summary: Get maintenance requirement by ID
      tags: [Maintenance]
      parameters:
        - name: id
          in: path
          required: true
          description: UUID of the maintenance requirement to retrieve
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Maintenance requirement retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaintenanceRequirementResponse"
        "404":
          $ref: "#/components/responses/NotFound"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"
    patch:
      summary: Update maintenance requirement
      description: |
        Update an existing maintenance requirement. 

        **Overlap Validation:** When updating dates or vehicle/maintenance IDs, the system checks for overlapping periods.
        Returns 409 Conflict if the update would create an overlap with another requirement.
      tags: [Maintenance]
      parameters:
        - name: id
          in: path
          required: true
          description: UUID of the maintenance requirement to update
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MaintenanceRequirementUpdateInput"
      responses:
        "200":
          description: Maintenance requirement updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaintenanceRequirementResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          description: Maintenance requirement not found
        "409":
          description: Overlapping requirement exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          $ref: "#/components/responses/InternalServerError"
    delete:
      summary: Delete maintenance requirement
      description: Remove a maintenance requirement from a vehicle
      tags: [Maintenance]
      parameters:
        - name: id
          in: path
          required: true
          description: UUID of the maintenance requirement to delete
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Maintenance requirement deleted successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          description: Maintenance requirement not found
        "500":
          $ref: "#/components/responses/InternalServerError"

  # MAINTENANCE RECORDS
  /maintenance/records:
    get:
      summary: Get all maintenance records with optional filters
      description: |
        Get all maintenance records with optional search and filters.

        **Search:** `search` - Search across maintenance name, notes, user firstName, lastName, email, and vehicle licensePlate

        **Filters:**
        - `userId` - Filter by specific user ID
        - `vehicleId` - Filter by specific vehicle ID
        - `maintenanceId` - Filter by maintenance type ID
      tags: [Maintenance]
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/LimitParam"
        - $ref: "#/components/parameters/SearchParam"
        - name: userId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by user ID
        - name: vehicleId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by vehicle ID
        - name: maintenanceId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by maintenance type ID
      responses:
        "200":
          description: List of maintenance records retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaintenanceRecordListResponse"
        "500":
          $ref: "#/components/responses/InternalServerError"
    post:
      summary: Add a new maintenance record
      tags: [Maintenance]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MaintenanceRecordInput"
      responses:
        "201":
          description: Maintenance record created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaintenanceRecordResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /maintenance/records/vehicle/{vehicleId}:
    get:
      summary: Get maintenance records for a specific vehicle
      tags: [Maintenance]
      parameters:
        - name: vehicleId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Vehicle maintenance records retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaintenanceRecordListResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /maintenance/records/{id}:
    get:
      summary: Get maintenance record by ID
      tags: [Maintenance]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Maintenance record retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MaintenanceRecordResponse"
        "404":
          $ref: "#/components/responses/NotFound"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # QUARTERLY CONTROLS
  /quarterly-controls:
    get:
      summary: Get all quarterly controls with pagination and search
      description: |
        Get quarterly controls with optional search and filters.

        **Search:** `search` - Search across vehicle license plate, user names, etc.

        **Filters:**
        - `vehicleId` - Filter by vehicle UUID
        - `year` - Filter by year
        - `quarter` - Filter by quarter (1-4)
        - `filledBy` - Filter by user UUID who filled the control
      tags: [Maintenance]
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/LimitParam"
        - $ref: "#/components/parameters/SearchParam"
        - name: vehicleId
          in: query
          schema:
            type: string
            format: uuid
        - name: year
          in: query
          schema:
            type: integer
        - name: quarter
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 4
        - name: filledBy
          in: query
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: List of quarterly controls
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuarterlyControlListResponse"
    post:
      summary: Create a new quarterly control
      tags: [Maintenance]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/QuarterlyControlInput"
      responses:
        "201":
          description: Quarterly control created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuarterlyControlResponse"

  /quarterly-controls/with-items:
    post:
      summary: Create a quarterly control with items (Admin only)
      description: Creates a quarterly control and its items in a single transaction
      tags: [Maintenance]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/QuarterlyControlWithItemsInput"
      responses:
        "201":
          description: Quarterly control with items created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuarterlyControlResponse"

  /quarterly-controls/{id}:
    get:
      summary: Get quarterly control by ID
      tags: [Maintenance]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Quarterly control found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuarterlyControlResponse"
    patch:
      summary: Update quarterly control
      tags: [Maintenance]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/QuarterlyControlUpdateInput"
      responses:
        "200":
          description: Quarterly control updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuarterlyControlResponse"
    delete:
      summary: Delete quarterly control
      tags: [Maintenance]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Quarterly control deleted successfully

  /quarterly-controls/{id}/with-items:
    patch:
      summary: Update quarterly control with items
      description: Updates quarterly control and its items in a single transaction
      tags: [Maintenance]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/QuarterlyControlPatchWithItemsInput"
      responses:
        "200":
          description: Quarterly control with items updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuarterlyControlResponse"

  # QUARTERLY CONTROL ITEMS
  /quarterly-control-items:
    get:
      summary: Get all quarterly control items
      tags: [Maintenance]
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/LimitParam"
        - $ref: "#/components/parameters/SearchParam"
        - name: quarterlyControlId
          in: query
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          schema:
            type: string
            enum: [PENDIENTE, APROBADO, RECHAZADO]
      responses:
        "200":
          description: List of quarterly control items
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuarterlyControlItemListResponse"

  /quarterly-control-items/{id}:
    get:
      summary: Get quarterly control item by ID
      tags: [Maintenance]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Item found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuarterlyControlItemResponse"
    patch:
      summary: Update quarterly control item
      tags: [Maintenance]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/QuarterlyControlItemUpdateInput"
      responses:
        "200":
          description: Item updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuarterlyControlItemResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"
    delete:
      summary: Delete quarterly control item
      description: Admin only. Delete a quarterly control item.
      tags: [Maintenance]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Quarterly control item deleted successfully
        "404":
          $ref: "#/components/responses/NotFound"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # METRICS ENDPOINTS
  /metrics/vehicles/count:
    get:
      summary: Get total vehicle count
      description: Returns the total number of vehicles in the system. Admin only.
      tags: [Metrics]
      responses:
        "200":
          $ref: "#/components/responses/VehicleCountResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /metrics/vehicles/kilometers:
    get:
      summary: Get vehicles by kilometer buckets
      description: |
        Returns vehicle count grouped by dynamic kilometer buckets.
        Bucket size is configurable. Admin only.

        **Drill-down:** Use `GET /vehicles` with appropriate filters.
      tags: [Metrics]
      parameters:
        - name: bucketSize
          in: query
          schema:
            type: integer
            default: 20000
            minimum: 1000
          description: Size of each bucket in kilometers (default 20,000 km)
        - name: maxBuckets
          in: query
          schema:
            type: integer
            default: 10
            minimum: 1
            maximum: 20
          description: Maximum number of buckets to return
        - name: minBucketsToShow
          in: query
          schema:
            type: integer
            default: 5
            minimum: 1
            maximum: 20
          description: Minimum number of buckets to display (fills with empty if needed)
      responses:
        "200":
          $ref: "#/components/responses/BucketListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /metrics/vehicles/age:
    get:
      summary: Get vehicles by age buckets
      description: |
        Returns vehicle count grouped by dynamic age buckets (years).
        Bucket size is configurable. Admin only.

        **Drill-down:** Use `GET /vehicles` with year filter.
      tags: [Metrics]
      parameters:
        - name: bucketSize
          in: query
          schema:
            type: integer
            default: 1
            minimum: 1
          description: Size of each bucket in years (default 1 year)
        - name: maxBuckets
          in: query
          schema:
            type: integer
            default: 10
            minimum: 1
            maximum: 20
          description: Maximum number of buckets to return
        - name: minBucketsToShow
          in: query
          schema:
            type: integer
            default: 5
            minimum: 1
            maximum: 20
          description: Minimum number of buckets to display (fills with empty if needed)
      responses:
        "200":
          $ref: "#/components/responses/BucketListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /metrics/vehicles/fuel-type:
    get:
      summary: Get vehicles by fuel type
      description: |
        Returns vehicle count grouped by fuel type.
        Admin only.

        **Drill-down:** Use `GET /vehicles` with fuelType filter (to be added).
      tags: [Metrics]
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 50
          description: Optional limit for top N results
      responses:
        "200":
          $ref: "#/components/responses/DistributionListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /metrics/vehicles/brand:
    get:
      summary: Get vehicles by brand
      description: |
        Returns vehicle count grouped by brand.
        Response includes brandId for drill-down queries.
        Admin only.

        **Drill-down:** Use `GET /vehicles?brandId={id}` to get vehicles of a specific brand.
      tags: [Metrics]
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 50
          description: Optional limit for top N results
      responses:
        "200":
          $ref: "#/components/responses/DistributionListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /metrics/reservations:
    get:
      summary: Get reservations timeline
      description: |
        Returns reservation count grouped by month.
        Admin only.

        **Drill-down:** Use `GET /reservations` with date filters.
      tags: [Metrics]
      parameters:
        - name: months
          in: query
          schema:
            type: integer
            default: 12
            minimum: 1
            maximum: 36
          description: Number of months to include in timeline
      responses:
        "200":
          $ref: "#/components/responses/TimelineResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /metrics/maintenance-records:
    get:
      summary: Get maintenance records timeline
      description: |
        Returns maintenance record count grouped by month.
        Admin only.

        **Drill-down:** Use `GET /maintenance/records` with date filters.
      tags: [Metrics]
      parameters:
        - name: months
          in: query
          schema:
            type: integer
            default: 12
            minimum: 1
            maximum: 36
          description: Number of months to include in timeline
      responses:
        "200":
          $ref: "#/components/responses/TimelineResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /metrics/quarterly-controls:
    get:
      summary: Get quarterly controls by status
      description: |
        Returns quarterly control aggregation by status per quarter.
        Results ordered from most recent to oldest.
        Admin only.

        **Drill-down:** Use `GET /quarterly-controls` with year/quarter filters.
      tags: [Metrics]
      parameters:
        - name: periods
          in: query
          schema:
            type: integer
            default: 8
            minimum: 1
            maximum: 20
          description: Number of quarters to return (default 8 = 2 years)
      responses:
        "200":
          $ref: "#/components/responses/QuarterlyControlMetricsResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /metrics/drivers:
    get:
      summary: Get driver assignments metrics
      description: |
        Returns current active driver count and assignments timeline by month.
        Admin only.

        **Drill-down:** Use `GET /assignments` with date filters.
      tags: [Metrics]
      parameters:
        - name: months
          in: query
          schema:
            type: integer
            default: 12
            minimum: 1
            maximum: 36
          description: Number of months for timeline
      responses:
        "200":
          $ref: "#/components/responses/PersonnelMetricsResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /metrics/responsibles:
    get:
      summary: Get vehicle responsibles metrics
      description: |
        Returns current active responsibles count and assignments timeline by month.
        Admin only.

        **Drill-down:** Use `GET /vehicle-responsibles` with date filters.
      tags: [Metrics]
      parameters:
        - name: months
          in: query
          schema:
            type: integer
            default: 12
            minimum: 1
            maximum: 36
          description: Number of months for timeline
      responses:
        "200":
          $ref: "#/components/responses/PersonnelMetricsResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  # RISK INDICATORS
  /risks/summary:
    get:
      summary: Get risk indicators summary
      description: Returns aggregated counts of all risk indicators. Admin only.
      tags: [Risks]
      parameters:
        - name: toleranceDays
          in: query
          description: Number of tolerance days before considering something overdue
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: daysWithoutUpdate
          in: query
          description: Number of days without kilometer update to consider a vehicle at risk
          schema:
            type: integer
            minimum: 1
            default: 30
      responses:
        "200":
          $ref: "#/components/responses/RiskSummaryResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /risks/vehicles-without-responsible:
    get:
      summary: Get vehicles without current responsible
      description: Returns vehicles that have no active responsible assignment. Admin only.
      tags: [Risks]
      parameters:
        - name: search
          in: query
          description: Filter by vehicle license plate
          schema:
            type: string
        - $ref: "#/components/parameters/limitParam"
        - $ref: "#/components/parameters/offsetParam"
      responses:
        "200":
          $ref: "#/components/responses/VehiclesWithoutResponsibleResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /risks/overdue-maintenance-vehicles:
    get:
      summary: Get vehicles with overdue maintenance
      description: Returns vehicles that have at least one overdue maintenance requirement (by days or kilometers). Admin only.
      tags: [Risks]
      parameters:
        - name: search
          in: query
          description: Filter by vehicle license plate, maintenance name, model name, or brand name
          schema:
            type: string
        - name: toleranceDays
          in: query
          description: Number of tolerance days before considering maintenance overdue
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: maintenanceId
          in: query
          description: Filter by specific maintenance type (UUID)
          schema:
            type: string
            format: uuid
        - name: modelId
          in: query
          description: Filter by specific vehicle model (UUID)
          schema:
            type: string
            format: uuid
        - $ref: "#/components/parameters/limitParam"
        - $ref: "#/components/parameters/offsetParam"
      responses:
        "200":
          $ref: "#/components/responses/OverdueMaintenanceResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /risks/overdue-quarterly-controls:
    get:
      summary: Get overdue quarterly controls
      description: Returns quarterly controls past their intended delivery date that haven't been filled. Admin only.
      tags: [Risks]
      parameters:
        - name: search
          in: query
          description: Filter by vehicle license plate
          schema:
            type: string
        - name: toleranceDays
          in: query
          description: Number of tolerance days before considering a control overdue
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: year
          in: query
          description: Filter by year (2000-2030)
          schema:
            type: integer
            minimum: 2000
            maximum: 2030
        - name: quarter
          in: query
          description: Filter by quarter (1-4)
          schema:
            type: integer
            minimum: 1
            maximum: 4
        - $ref: "#/components/parameters/limitParam"
        - $ref: "#/components/parameters/offsetParam"
      responses:
        "200":
          $ref: "#/components/responses/OverdueQuarterlyControlsResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /risks/quarterly-controls-with-errors:
    get:
      summary: Get quarterly controls with rejected items
      description: Returns quarterly controls that have items with RECHAZADO status. Admin only.
      tags: [Risks]
      parameters:
        - name: search
          in: query
          description: Filter by vehicle license plate
          schema:
            type: string
        - name: year
          in: query
          description: Filter by year (2000-2030)
          schema:
            type: integer
            minimum: 2000
            maximum: 2030
        - name: quarter
          in: query
          description: Filter by quarter (1-4)
          schema:
            type: integer
            minimum: 1
            maximum: 4
        - name: minRejectedItems
          in: query
          description: Minimum number of rejected items to include the control
          schema:
            type: integer
            minimum: 1
            default: 1
        - $ref: "#/components/parameters/limitParam"
        - $ref: "#/components/parameters/offsetParam"
      responses:
        "200":
          $ref: "#/components/responses/QuarterlyControlsWithErrorsResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /risks/vehicles-without-recent-kilometers:
    get:
      summary: Get vehicles without recent kilometer readings
      description: Returns vehicles that have not reported kilometer readings in the configured recent period. Admin only.
      tags: [Risks]
      parameters:
        - name: search
          in: query
          description: Filter by vehicle license plate
          schema:
            type: string
        - name: daysWithoutUpdate
          in: query
          description: Number of days without update to consider a vehicle at risk
          schema:
            type: integer
            minimum: 1
            default: 30
        - $ref: "#/components/parameters/limitParam"
        - $ref: "#/components/parameters/offsetParam"
      responses:
        "200":
          $ref: "#/components/responses/VehiclesWithoutRecentKilometersResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  # VEHICLE RESPONSIBLES
  /vehicle-responsibles:
    get:
      summary: Get all vehicle responsibles with optional filters
      description: |
        Get all vehicle responsibility assignments with optional search and filters.

        **Search:** `search` - Search across user firstName, lastName, email, and vehicle licensePlate, chassisNumber

        **Filters:**
        - `userId` - Filter by specific user ID
        - `vehicleId` - Filter by specific vehicle ID
        - `active` - Filter by active status (true/false)
        - `date` - Filter by specific date (YYYY-MM-DD)
      tags: [Vehicle Responsibles]
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/LimitParam"
        - $ref: "#/components/parameters/SearchParam"
        - name: userId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by user ID
        - name: vehicleId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by vehicle ID
        - name: active
          in: query
          schema:
            type: boolean
          description: Filter by active status
        - name: date
          in: query
          schema:
            type: string
            format: date
          description: Filter by specific date (YYYY-MM-DD)
      responses:
        "200":
          description: List of vehicle responsibles retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VehicleResponsibleListResponse"
        "500":
          $ref: "#/components/responses/InternalServerError"
    post:
      summary: Create a new vehicle responsible assignment
      description: |
        Create a new vehicle responsible assignment. This will automatically end any current 
        active responsibility for the same vehicle by setting the end date to the day before 
        the new assignment starts.
      tags: [Vehicle Responsibles]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VehicleResponsibleInput"
      responses:
        "201":
          description: Vehicle responsible created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VehicleResponsibleResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          description: Conflicting responsibility periods
        "500":
          $ref: "#/components/responses/InternalServerError"

  /vehicle-responsibles/{id}:
    get:
      summary: Get vehicle responsible by ID
      tags: [Vehicle Responsibles]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Vehicle responsible found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VehicleResponsibleResponse"
        "404":
          $ref: "#/components/responses/NotFound"
    patch:
      summary: Update vehicle responsible
      tags: [Vehicle Responsibles]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VehicleResponsibleInput"
      responses:
        "200":
          description: Vehicle responsible updated successfully
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          description: Conflicting responsibility periods
    delete:
      summary: Delete vehicle responsible
      tags: [Vehicle Responsibles]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Vehicle responsible deleted successfully
        "404":
          description: Vehicle responsible not found

  /vehicle-responsibles/vehicle/{vehicleId}/current:
    get:
      summary: Get current responsible for a vehicle
      description: Get the currently active responsible for a specific vehicle
      tags: [Vehicle Responsibles]
      parameters:
        - name: vehicleId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Current responsible found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VehicleResponsibleResponse"
        "404":
          description: No current responsible found for this vehicle

  /vehicle-responsibles/user/{userId}/current:
    get:
      summary: Get current vehicles under a user's responsibility
      description: Get all vehicles currently under the responsibility of a specific user
      tags: [Vehicle Responsibles]
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Current vehicles found
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/VehicleResponsibleWithDetails"

  # VEHICLE BRANDS
  /vehicle-brands:
    get:
      summary: List vehicle brands
      description: |
        Get vehicle brands with optional search and filters.

        **Search:** `search` - Search by brand name

        **Filters:**
        - `name` - Partial match by brand name
      tags: [Vehicle Brands]
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/LimitParam"
        - $ref: "#/components/parameters/SearchParam"
        - name: name
          in: query
          description: Partial match by brand name
          schema:
            type: string
      responses:
        "200":
          description: List of brands
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VehicleBrandListResponse"
    post:
      summary: Create vehicle brand
      tags: [Vehicle Brands]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VehicleBrandInput"
      responses:
        "201":
          description: Brand created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VehicleBrandResponse"

  /vehicle-brands/{id}:
    get:
      summary: Get vehicle brand by ID
      tags: [Vehicle Brands]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Brand found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VehicleBrandResponse"
        "404":
          $ref: "#/components/responses/NotFound"
    patch:
      summary: Update vehicle brand
      tags: [Vehicle Brands]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VehicleBrandInput"
      responses:
        "200":
          description: Brand updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VehicleBrandResponse"
        "404":
          $ref: "#/components/responses/NotFound"
    delete:
      summary: Delete vehicle brand
      tags: [Vehicle Brands]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Brand deleted
        "404":
          $ref: "#/components/responses/NotFound"

  # VEHICLE MODELS
  /vehicle-models:
    get:
      summary: List vehicle models
      description: |
        Get vehicle models with optional search and filters.

        **Search:** `search` - Search across model name and brand name

        **Filters:**
        - `name` - Partial match by model name
        - `brandId` - Exact match by brand UUID
      tags: [Vehicle Models]
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/LimitParam"
        - $ref: "#/components/parameters/SearchParam"
        - name: name
          in: query
          description: Partial match by model name
          schema:
            type: string
        - name: brandId
          in: query
          description: Filter by brand UUID
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: List of models
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VehicleModelListResponse"
    post:
      summary: Create vehicle model
      tags: [Vehicle Models]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VehicleModelInput"
      responses:
        "201":
          description: Model created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VehicleModelResponse"

  /vehicle-models/{id}:
    get:
      summary: Get vehicle model by ID
      tags: [Vehicle Models]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Model found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VehicleModelResponse"
        "404":
          $ref: "#/components/responses/NotFound"
    patch:
      summary: Update vehicle model
      tags: [Vehicle Models]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VehicleModelInput"
      responses:
        "200":
          description: Model updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VehicleModelResponse"
        "404":
          $ref: "#/components/responses/NotFound"
    delete:
      summary: Delete vehicle model
      tags: [Vehicle Models]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Model deleted
        "404":
          $ref: "#/components/responses/NotFound"

  # VEHICLE ACL (Access Control List)
  /vehicle-acl:
    get:
      summary: Get all vehicle ACLs
      description: |
        Get all vehicle access control entries with optional search and filters. Admin only.

        **Search:** `search` - Search across user firstName, lastName, email, and vehicle licensePlate, chassisNumber

        **Filters:**
        - `userId` - Filter by user ID
        - `vehicleId` - Filter by vehicle ID
        - `permission` - Filter by permission level
        - `activeAt` - Filter ACLs active at specific time
      tags: [Vehicle ACL]
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/LimitParam"
        - $ref: "#/components/parameters/SearchParam"
        - name: userId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by user ID
        - name: vehicleId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by vehicle ID
        - name: permission
          in: query
          schema:
            type: string
            enum: [Read, Maintainer, Driver, Full]
          description: Filter by permission level
        - name: active
          in: query
          schema:
            type: boolean
          description: Filter ACLs active at current time
      responses:
        "200":
          description: List of vehicle ACLs
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VehicleACLListResponse"
        "403":
          $ref: "#/components/responses/Forbidden"
    post:
      summary: Create a new vehicle ACL
      description: Admin only. Grant a user permission to access a vehicle.
      tags: [Vehicle ACL]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VehicleACLInput"
      responses:
        "201":
          description: Vehicle ACL created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VehicleACLResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "403":
          $ref: "#/components/responses/Forbidden"

  /vehicle-acl/{id}:
    get:
      summary: Get vehicle ACL by ID
      tags: [Vehicle ACL]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Vehicle ACL retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VehicleACLResponse"
        "404":
          $ref: "#/components/responses/NotFound"
    patch:
      summary: Update vehicle ACL
      description: Admin only.
      tags: [Vehicle ACL]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VehicleACLUpdateInput"
      responses:
        "200":
          description: Vehicle ACL updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VehicleACLResponse"
        "404":
          $ref: "#/components/responses/NotFound"
    delete:
      summary: Delete vehicle ACL
      description: Admin only.
      tags: [Vehicle ACL]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Vehicle ACL deleted
        "404":
          $ref: "#/components/responses/NotFound"

  /vehicle-acl/user/{userId}/active:
    get:
      summary: Get active vehicle ACLs for a user
      description: Get all currently active vehicle permissions for a specific user.
      tags: [Vehicle ACL]
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: List of active vehicle ACLs for the user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VehicleACLListResponse"

  # USER ROLES
  /user-roles:
    get:
      summary: Get all user roles
      description: |
        Get all user role assignments with optional search and filters. Admin only.

        **Search:** `search` - Search across user firstName, lastName, and email

        **Filters:**
        - `userId` - Filter by user ID
        - `role` - Filter by role (user/admin)
        - `activeOnly` - Filter only active roles
      tags: [User Roles]
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/LimitParam"
        - $ref: "#/components/parameters/SearchParam"
        - name: userId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by user ID
        - name: role
          in: query
          schema:
            type: string
            enum: [user, admin]
          description: Filter by role
        - name: active
          in: query
          schema:
            type: boolean
          description: Filter by active status
      responses:
        "200":
          description: List of user roles
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserRoleListResponse"
    post:
      summary: Create a new user role
      description: Admin only. Assign a role to a user.
      tags: [User Roles]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserRoleInput"
      responses:
        "201":
          description: User role created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserRoleResponse"

  /user-roles/{id}:
    get:
      summary: Get user role by ID
      tags: [User Roles]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: User role retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserRoleResponse"
    patch:
      summary: Update user role
      description: Admin only.
      tags: [User Roles]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserRoleUpdateInput"
      responses:
        "200":
          description: User role updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserRoleResponse"
    delete:
      summary: Delete user role
      description: Admin only.
      tags: [User Roles]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: User role deleted

  /user-roles/user/{userId}:
    get:
      summary: Get all roles for a user
      description: Get all role assignments for a specific user (active and inactive).
      tags: [User Roles]
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: List of user roles
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserRoleListResponse"

  /user-roles/user/{userId}/active:
    get:
      summary: Get active role for a user
      description: Get the currently active role for a specific user.
      tags: [User Roles]
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Active user role
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserRoleResponse"
        "404":
          description: No active role found

  /user-roles/{id}/finish:
    patch:
      summary: Finish a user role
      description: Finish a user role by setting an end time. Admin only.
      tags: [User Roles]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                endTime:
                  type: string
                  format: date-time
                  description: Optional end time (defaults to now)
      responses:
        "200":
          description: User role finished successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserRoleResponse"
        "404":
          description: User role not found

components:
  schemas:
    VehicleKilometersLog:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user:
          $ref: "#/components/schemas/User"
        vehicle:
          $ref: "#/components/schemas/Vehicle"
        date:
          type: string
          format: date-time
        kilometers:
          type: integer
          minimum: 0
        createdAt:
          type: string
          format: date-time
      required:
        - user
        - vehicle
        - date
        - kilometers

    VehicleKilometersLogCreateInput:
      type: object
      properties:
        vehicleId:
          type: string
          format: uuid
          description: UUID of the vehicle
        userId:
          type: string
          format: uuid
          description: UUID of the user recording the kilometers
        date:
          type: string
          format: date-time
          description: Date and time when the reading was taken
        kilometers:
          type: integer
          minimum: 0
          description: Kilometers reading (must maintain chronological order)
      required:
        - vehicleId
        - userId
        - date
        - kilometers

    VehicleKilometersLogUpdateInput:
      type: object
      properties:
        vehicleId:
          type: string
          format: uuid
          description: UUID of the vehicle (optional)
        userId:
          type: string
          format: uuid
          description: UUID of the user (optional)
        date:
          type: string
          format: date-time
          description: Date and time when the reading was taken (optional)
        kilometers:
          type: integer
          minimum: 0
          description: Kilometers reading (must maintain chronological order)
      minProperties: 1
      description: At least one field must be provided for update

    VehicleKilometersLogResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/VehicleKilometersLog"

    VehicleKilometersLogListResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: "#/components/schemas/VehicleKilometersLog"
    # RFC 7807 Problem Details for HTTP APIs
    ProblemDetails:
      type: object
      description: RFC 7807 Problem Details for HTTP APIs
      properties:
        type:
          type: string
          format: uri
          description: A URI reference that identifies the problem type
          example: "https://example.com/problems/validation-error"
        title:
          type: string
          description: A short, human-readable summary of the problem type
          example: "Validation Failed"
        status:
          type: integer
          description: The HTTP status code
          example: 400
        detail:
          type: string
          description: A human-readable explanation specific to this occurrence
          example: "The request contains invalid data"
        instance:
          type: string
          format: uri
          description: A URI reference that identifies the specific occurrence
          example: "/users/123"
      required:
        - type
        - title
        - status

    ValidationProblemDetails:
      allOf:
        - $ref: "#/components/schemas/ProblemDetails"
        - type: object
          properties:
            errors:
              type: array
              description: List of validation errors
              items:
                type: object
                properties:
                  field:
                    type: string
                    description: The field that failed validation
                    example: "email"
                  message:
                    type: string
                    description: The validation error message
                    example: "Invalid email format"
                  code:
                    type: string
                    description: The validation error code
                    example: "invalid_string"

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        firstName:
          type: string
          example: "Juan"
        lastName:
          type: string
          example: "Pérez"
        cuit:
          type: string
          example: "20345678901"
          description: "CUIT (11 digits)"
        email:
          type: string
          format: email
          example: "juan.perez@example.com"
        entraId:
          type: string
          example: ""
          description: "Microsoft Entra ID unique identifier. Empty string means not yet linked."
        active:
          type: boolean
          example: true
          description: "Whether the user is active or deactivated"
      required:
        - id
        - firstName
        - lastName
        - cuit
        - email
        - entraId
        - active

    UserInput:
      type: object
      properties:
        firstName:
          type: string
          minLength: 1
          maxLength: 50
        lastName:
          type: string
          minLength: 1
          maxLength: 50
        cuit:
          type: string
          pattern: "^[0-9]{11}$"
          example: "20345678901"
          description: "CUIT (11 digits)"
        email:
          type: string
          format: email
        active:
          type: boolean
          default: true
          description: "Whether the user is active or deactivated"
      required:
        - firstName
        - lastName
        - cuit
        - email

    UserUpdateInput:
      allOf:
        - $ref: "#/components/schemas/UserInput"

    Vehicle:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "650e8400-e29b-41d4-a716-446655440001"
        licensePlate:
          type: string
          pattern: "^[A-Z]{3}[0-9]{3}$"
          example: "ABC123"
        model:
          type: object
          description: Vehicle model with nested brand
          properties:
            id:
              type: string
              format: uuid
              example: "aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee"
            name:
              type: string
              example: "Corolla"
            vehicleType:
              type: string
              nullable: true
              description: "Tipo de vehículo (sedán, pickup, SUV, utilitario, etc.)"
              example: "SUV"
            brand:
              type: object
              properties:
                id:
                  type: string
                  format: uuid
                  example: "11111111-2222-3333-4444-555555555555"
                name:
                  type: string
                  example: "Toyota"
              required:
                - id
                - name
          required:
            - id
            - name
            - brand
        year:
          type: integer
          minimum: 1900
          maximum: 2030
          example: 2022
        chassisNumber:
          type: string
          nullable: true
          description: "Número de chasis"
          example: "8ADZZZ12345678901"
        engineNumber:
          type: string
          nullable: true
          description: "Número de motor"
          example: "1NZ-FE-987654321"
        transmission:
          type: string
          nullable: true
          description: "Tipo de transmisión (manual, automática, CVT, etc.)"
          example: "Automática"
        fuelType:
          type: string
          nullable: true
          description: "Tipo de combustible (nafta, diésel, híbrido, eléctrico, etc.)"
          example: "Nafta"
        registrationDate:
          type: string
          format: date
          description: "Fecha de alta del vehículo en el sistema"
          example: "2022-01-15"
        currentResponsible:
          allOf:
            - $ref: "#/components/schemas/VehicleResponsibleWithDetails"
            - nullable: true
          description: "Current responsible for the vehicle (only included in detailed views)"
      required:
        - id
        - licensePlate
        - model
        - year
        - registrationDate

    VehicleInput:
      type: object
      properties:
        licensePlate:
          type: string
          pattern: "^[A-Z]{3}[0-9]{3}$"
        modelId:
          type: string
          format: uuid
          description: UUID del modelo del vehículo
        year:
          type: integer
          minimum: 1900
          maximum: 2030
        chassisNumber:
          type: string
          description: "Número de chasis"
        engineNumber:
          type: string
          description: "Número de motor"
        transmission:
          type: string
          description: "Transmisión"
        fuelType:
          type: string
          description: "Combustible"
        registrationDate:
          type: string
          format: date
          description: "Fecha de alta del vehículo"
          example: "2022-01-15"
      required:
        - licensePlate
        - modelId
        - year
        - registrationDate

    VehicleUpdateInput:
      type: object
      description: Campos de vehículo para actualización parcial o total. Todos los campos son opcionales.
      properties:
        licensePlate:
          type: string
          pattern: "^[A-Z]{3}[0-9]{3}$"
        modelId:
          type: string
          format: uuid
          description: UUID del modelo (para cambiar el modelo del vehículo)
        year:
          type: integer
          minimum: 1900
          maximum: 2030
        chassisNumber:
          type: string
        engineNumber:
          type: string
        transmission:
          type: string
        fuelType:
          type: string
        registrationDate:
          type: string
          format: date
          description: "Fecha de alta del vehículo"
      minProperties: 1

    # VEHICLE BRAND & MODEL SCHEMAS
    VehicleBrand:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "11111111-2222-3333-4444-555555555555"
        name:
          type: string
          example: "Toyota"
      required:
        - id
        - name

    VehicleBrandInput:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
      required:
        - name

    VehicleBrandResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/VehicleBrand"

    VehicleBrandListResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: "#/components/schemas/VehicleBrand"

    VehicleModel:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee"
        name:
          type: string
          example: "Corolla"
        vehicleType:
          type: string
          nullable: true
          description: Tipo de vehículo (auto, camioneta, SUV, etc.)
          example: "SUV"
        brand:
          $ref: "#/components/schemas/VehicleBrand"
      required:
        - id
        - name
        - brand

    VehicleModelInput:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
        brandId:
          type: string
          format: uuid
        vehicleType:
          type: string
          description: Tipo de vehículo (auto, camioneta, SUV, etc.)
      required:
        - name
        - brandId

    VehicleModelResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/VehicleModel"

    VehicleModelListResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: "#/components/schemas/VehicleModel"

    # VEHICLE RESPONSIBLE SCHEMAS
    VehicleResponsible:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "d50e8400-e29b-41d4-a716-446655440008"
        vehicleId:
          type: string
          format: uuid
          example: "650e8400-e29b-41d4-a716-446655440001"
        userId:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        startDate:
          type: string
          format: date
          example: "2025-01-15"
          description: "Start date of the responsibility period"
        endDate:
          type: string
          format: date
          nullable: true
          example: "2025-12-31"
          description: "End date of the responsibility period (null means currently active)"
        createdAt:
          type: string
          format: date-time
          example: "2025-01-15T09:00:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-01-15T09:00:00Z"
      required:
        - id
        - vehicleId
        - userId
        - startDate

    VehicleResponsibleWithDetails:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "d50e8400-e29b-41d4-a716-446655440008"
        startDate:
          type: string
          format: date
          example: "2025-01-15"
          description: "Start date of the responsibility period"
        endDate:
          type: string
          format: date
          nullable: true
          example: "2025-12-31"
          description: "End date of the responsibility period (null means currently active)"
        user:
          $ref: "#/components/schemas/User"
        vehicle:
          $ref: "#/components/schemas/Vehicle"
      required:
        - id
        - startDate
        - user
        - vehicle

    VehicleResponsibleInput:
      type: object
      properties:
        vehicleId:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        startDate:
          type: string
          format: date
          description: "Start date of the responsibility period (defaults to today if not provided)"
        endDate:
          type: string
          format: date
          nullable: true
          description: "End date of the responsibility period (null means indefinite)"
      required:
        - vehicleId
        - userId

    VehicleResponsibleResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/VehicleResponsibleWithDetails"

    VehicleResponsibleListResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: "#/components/schemas/VehicleResponsibleWithDetails"

    # Response schemas
    ApiResponse:
      type: object
      properties:
        status:
          type: string
          enum: [success, error]
        message:
          type: string
        data:
          type: object
        pagination:
          $ref: "#/components/schemas/Pagination"

    Pagination:
      type: object
      properties:
        page:
          type: integer
          minimum: 1
        limit:
          type: integer
          minimum: 1
        total:
          type: integer
          minimum: 0
        pages:
          type: integer
          minimum: 0

    UserResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/User"

    UserListResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: "#/components/schemas/User"

    VehicleResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/Vehicle"

    VehicleListResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: "#/components/schemas/Vehicle"

    ErrorResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            status:
              type: string
              enum: [error]
            errors:
              type: array
              items:
                type: object
                properties:
                  field:
                    type: string
                  message:
                    type: string

    # RESERVATION SCHEMAS
    Reservation:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "750e8400-e29b-41d4-a716-446655440002"
        startDate:
          type: string
          format: date-time
          example: "2025-01-15T09:00:00Z"
        endDate:
          type: string
          format: date-time
          example: "2025-01-15T17:00:00Z"
        user:
          $ref: "#/components/schemas/User"
        vehicle:
          $ref: "#/components/schemas/Vehicle"
      required:
        - id
        - startDate
        - endDate
        - user
        - vehicle

    ReservationInput:
      type: object
      properties:
        vehicleId:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        startDate:
          type: string
          format: date-time
        endDate:
          type: string
          format: date-time
      required:
        - vehicleId
        - userId
        - startDate
        - endDate

    ReservationUpdateInput:
      type: object
      properties:
        vehicleId:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        startDate:
          type: string
          format: date-time
        endDate:
          type: string
          format: date-time
      minProperties: 1
      description: "At least one field must be provided for update"

    ReservationResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/Reservation"

    ReservationListResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: "#/components/schemas/Reservation"

    # ASSIGNMENT SCHEMAS
    Assignment:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "850e8400-e29b-41d4-a716-446655440003"
        startDate:
          type: string
          format: date-time
          example: "2025-01-15T09:00:00Z"
          description: "Start date of the assignment"
        endDate:
          type: string
          format: date-time
          nullable: true
          example: "2025-12-31T17:00:00Z"
          description: "End date of the assignment (null means indefinite)"
        user:
          $ref: "#/components/schemas/User"
        vehicle:
          $ref: "#/components/schemas/Vehicle"
      required:
        - id
        - startDate
        - user
        - vehicle

    AssignmentInput:
      type: object
      properties:
        userId:
          type: string
          format: uuid
        vehicleId:
          type: string
          format: uuid
        startDate:
          type: string
          format: date-time
          description: "Start date of the assignment (defaults to today if not provided)"
        endDate:
          type: string
          format: date-time
          nullable: true
          description: "End date of the assignment (null means indefinite)"
      required:
        - userId
        - vehicleId

    AssignmentResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/Assignment"

    AssignmentListResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: "#/components/schemas/Assignment"

    # MAINTENANCE CATEGORY SCHEMAS
    MaintenanceCategory:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "950e8400-e29b-41d4-a716-446655440004"
        name:
          type: string
          example: "Motor"
      required:
        - id
        - name

    MaintenanceCategoryInput:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
          example: "Motor"
      required:
        - name

    MaintenanceCategoryResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/MaintenanceCategory"

    MaintenanceCategoryListResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: "#/components/schemas/MaintenanceCategory"

    # VEHICLE ACL SCHEMAS
    VehicleACL:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user:
          $ref: "#/components/schemas/User"
        vehicle:
          $ref: "#/components/schemas/Vehicle"
        permission:
          type: string
          enum: [Read, Maintainer, Driver, Full]
          description: "Permission level (Read < Maintainer < Driver < Full)"
        startTime:
          type: string
          format: date-time
          description: "When the permission starts"
        endTime:
          type: string
          format: date-time
          nullable: true
          description: "When the permission ends (null = no end date)"
      required:
        - id
        - user
        - vehicle
        - permission
        - startTime

    VehicleACLInput:
      type: object
      properties:
        userId:
          type: string
          format: uuid
        vehicleId:
          type: string
          format: uuid
        permission:
          type: string
          enum: [Read, Maintainer, Driver, Full]
        startTime:
          type: string
          format: date-time
        endTime:
          type: string
          format: date-time
          description: "Optional end date for the permission"
      required:
        - userId
        - vehicleId
        - permission
        - startTime

    VehicleACLUpdateInput:
      type: object
      properties:
        permission:
          type: string
          enum: [Read, Maintainer, Driver, Full]
        startTime:
          type: string
          format: date-time
        endTime:
          type: string
          format: date-time
          nullable: true

    VehicleACLResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/VehicleACL"

    VehicleACLListResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: "#/components/schemas/VehicleACL"

    # USER ROLE SCHEMAS
    UserRole:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user:
          $ref: "#/components/schemas/User"
        role:
          type: string
          enum: [user, admin]
        startTime:
          type: string
          format: date-time
          description: "When the role starts"
        endTime:
          type: string
          format: date-time
          nullable: true
          description: "When the role ends (null = no end date)"
        isActive:
          type: boolean
          description: "Computed field: true if current time is within start/end range"
      required:
        - id
        - user
        - role
        - startTime

    UserRoleInput:
      type: object
      properties:
        userId:
          type: string
          format: uuid
        role:
          type: string
          enum: [user, admin]
        startTime:
          type: string
          format: date-time
        endTime:
          type: string
          format: date-time
          description: "Optional end date for the role"
      required:
        - userId
        - role
        - startTime

    UserRoleUpdateInput:
      type: object
      properties:
        role:
          type: string
          enum: [user, admin]
        startTime:
          type: string
          format: date-time
        endTime:
          type: string
          format: date-time
          nullable: true

    UserRoleResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/UserRole"

    UserRoleListResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: "#/components/schemas/UserRole"

    # MAINTENANCE SCHEMAS
    Maintenance:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "a50e8400-e29b-41d4-a716-446655440005"
        categoryId:
          type: string
          format: uuid
          example: "950e8400-e29b-41d4-a716-446655440004"
        name:
          type: string
          example: "Cambio de aceite"
        kilometersFrequency:
          type: integer
          minimum: 0
          nullable: true
          example: 10000
        daysFrequency:
          type: integer
          minimum: 0
          nullable: true
          example: 90
        observations:
          type: string
          nullable: true
          example: "Usar aceite sintético"
        instructions:
          type: string
          nullable: true
          example: "Cambiar filtro y revisar tapa"
        category:
          type: object
          description: "Maintenance category"
          properties:
            name:
              type: string
              example: "Motor"
          required:
            - name
      required:
        - id
        - categoryId
        - name

    MaintenanceInput:
      type: object
      properties:
        categoryId:
          type: string
          format: uuid
          example: "950e8400-e29b-41d4-a716-446655440004"
        name:
          type: string
          minLength: 1
          maxLength: 100
          example: "Cambio de aceite"
        kilometersFrequency:
          type: integer
          minimum: 0
          description: "Frequency in kilometers"
        daysFrequency:
          type: integer
          minimum: 0
          description: "Frequency in days"
        observations:
          type: string
          description: "Observation notes"
        instructions:
          type: string
          description: "Step-by-step instructions"
      required:
        - categoryId
        - name

    MaintenanceResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/Maintenance"

    MaintenanceListResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: "#/components/schemas/Maintenance"

    # MAINTENANCE REQUIREMENT SCHEMAS
    MaintenanceRequirementInput:
      type: object
      properties:
        vehicleId:
          type: string
          format: uuid
          description: UUID of the vehicle
        maintenanceId:
          type: string
          format: uuid
          description: UUID of the maintenance type
        startDate:
          type: string
          format: date
          description: Start date of the requirement (YYYY-MM-DD)
          example: "2024-01-01"
        endDate:
          type: string
          format: date
          nullable: true
          description: End date of the requirement (YYYY-MM-DD). Null means ongoing.
          example: "2025-12-31"
        kilometersFrequency:
          type: integer
          minimum: 0
          nullable: true
          description: Frequency in kilometers (can be null)
        daysFrequency:
          type: integer
          minimum: 0
          nullable: true
          description: Frequency in days (can be null)
      required:
        - vehicleId
        - maintenanceId
        - startDate

    MaintenanceRequirement:
      type: object
      properties:
        id:
          type: string
          format: uuid
        vehicle:
          $ref: "#/components/schemas/Vehicle"
        maintenance:
          $ref: "#/components/schemas/Maintenance"
        startDate:
          type: string
          format: date
          description: Start date of the requirement
        endDate:
          type: string
          format: date
          nullable: true
          description: End date of the requirement (null means ongoing)
        kilometersFrequency:
          type: integer
          nullable: true
          minimum: 0
        daysFrequency:
          type: integer
          nullable: true
          minimum: 0
      required:
        - id
        - vehicle
        - maintenance
        - startDate

    MaintenanceRequirementResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/MaintenanceRequirement"

    MaintenanceRequirementListResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: "#/components/schemas/MaintenanceRequirement"

    MaintenanceRequirementUpdateInput:
      type: object
      properties:
        startDate:
          type: string
          format: date
          description: Start date of the requirement
        endDate:
          type: string
          format: date
          nullable: true
          description: End date of the requirement (null means ongoing)
        kilometersFrequency:
          type: integer
          minimum: 0
          nullable: true
          description: Frequency in kilometers
        daysFrequency:
          type: integer
          minimum: 0
          nullable: true
          description: Frequency in days
      minProperties: 1
      description: "At least one field must be provided for update"

    # MAINTENANCE RECORD SCHEMAS
    MaintenanceRecord:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "c50e8400-e29b-41d4-a716-446655440007"
        user:
          $ref: "#/components/schemas/User"
        vehicle:
          $ref: "#/components/schemas/Vehicle"
        maintenance:
          $ref: "#/components/schemas/Maintenance"
        date:
          type: string
          format: date-time
          example: "2025-01-10T14:30:00Z"
        kilometers:
          type: integer
          minimum: 0
          example: 75000
        notes:
          type: string
          nullable: true
          example: "Mantenimiento realizado según especificaciones del fabricante"
      required:
        - id
        - user
        - vehicle
        - maintenance
        - date
        - kilometers

    MaintenanceRecordInput:
      type: object
      properties:
        maintenanceId:
          type: string
          format: uuid
        vehicleId:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        date:
          type: string
          format: date-time
        kilometers:
          type: integer
          minimum: 0
        notes:
          type: string
      required:
        - maintenanceId
        - vehicleId
        - userId
        - date
        - kilometers

    MaintenanceRecordResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/MaintenanceRecord"

    MaintenanceRecordListResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: "#/components/schemas/MaintenanceRecord"

    # QUARTERLY CONTROL SCHEMAS
    QuarterlyControlItemStatus:
      type: string
      enum:
        - PENDIENTE
        - APROBADO
        - RECHAZADO

    QuarterlyControl:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "d50e8400-e29b-41d4-a716-446655440008"
        vehicle:
          $ref: "#/components/schemas/Vehicle"
        year:
          type: integer
          example: 2025
        quarter:
          type: integer
          minimum: 1
          maximum: 4
          example: 1
        intendedDeliveryDate:
          type: string
          format: date
          example: "2025-03-31"
        filledBy:
          allOf:
            - $ref: "#/components/schemas/User"
            - nullable: true
        filledAt:
          type: string
          format: date-time
          nullable: true
          example: "2025-01-15T14:30:00Z"
        items:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              category:
                type: string
              title:
                type: string
              status:
                $ref: "#/components/schemas/QuarterlyControlItemStatus"
              observations:
                type: string
      required:
        - id
        - vehicle
        - year
        - quarter
        - intendedDeliveryDate
        - items

    QuarterlyControlInput:
      type: object
      properties:
        vehicleId:
          type: string
          format: uuid
          description: UUID of the vehicle
        year:
          type: integer
          minimum: 2000
          maximum: 2100
          description: Year of the quarterly control
        quarter:
          type: integer
          minimum: 1
          maximum: 4
          description: Quarter of the year (1-4)
        intendedDeliveryDate:
          type: string
          format: date
          description: Intended delivery date (YYYY-MM-DD)
        filledBy:
          type: string
          format: uuid
          nullable: true
          description: UUID of the user who filled the quarterly control (optional)
        filledAt:
          type: string
          format: date-time
          nullable: true
          description: Date and time when the quarterly control was filled (optional)
      required:
        - vehicleId
        - year
        - quarter
        - intendedDeliveryDate

    QuarterlyControlUpdateInput:
      type: object
      properties:
        year:
          type: integer
          minimum: 2000
          maximum: 2100
        quarter:
          type: integer
          minimum: 1
          maximum: 4
        intendedDeliveryDate:
          type: string
          format: date
        filledBy:
          type: string
          format: uuid
          nullable: true
        filledAt:
          type: string
          format: date
          nullable: true

    QuarterlyControlWithItemsInput:
      type: object
      properties:
        vehicleId:
          type: string
          format: uuid
        year:
          type: integer
          minimum: 2000
          maximum: 2100
        quarter:
          type: integer
          minimum: 1
          maximum: 4
        intendedDeliveryDate:
          type: string
          format: date
        items:
          type: array
          items:
            type: object
            properties:
              title:
                type: string
              status:
                $ref: "#/components/schemas/QuarterlyControlItemStatus"
              observations:
                type: string
            required:
              - title
              - status
              - observations
      required:
        - vehicleId
        - year
        - quarter
        - intendedDeliveryDate
        - items

    QuarterlyControlPatchWithItemsInput:
      type: object
      properties:
        items:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
                description: UUID of the item to update
              status:
                $ref: "#/components/schemas/QuarterlyControlItemStatus"
              observations:
                type: string
            required:
              - id
              - status
              - observations
      required:
        - items

    QuarterlyControlResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/QuarterlyControl"

    QuarterlyControlListResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: "#/components/schemas/QuarterlyControl"

    # QUARTERLY CONTROL ITEM SCHEMAS
    QuarterlyControlItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "e50e8400-e29b-41d4-a716-446655440009"
        quarterlyControlId:
          type: string
          format: uuid
          example: "d50e8400-e29b-41d4-a716-446655440008"
        category:
          type: string
          example: "Motor y Fluidos"
        title:
          type: string
          example: "Check engine oil level"
        status:
          $ref: "#/components/schemas/QuarterlyControlItemStatus"
        observations:
          type: string
          example: "Everything looks good"
      required:
        - id
        - quarterlyControlId
        - category
        - title
        - status
        - observations

    QuarterlyControlItemInput:
      type: object
      properties:
        quarterlyControlId:
          type: string
          format: uuid
        category:
          type: string
        title:
          type: string
        status:
          $ref: "#/components/schemas/QuarterlyControlItemStatus"
        observations:
          type: string
      required:
        - quarterlyControlId
        - category
        - title
        - status
        - observations

    QuarterlyControlItemUpdateInput:
      type: object
      properties:
        status:
          $ref: "#/components/schemas/QuarterlyControlItemStatus"
        observations:
          type: string

    QuarterlyControlItemResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/QuarterlyControlItem"

    QuarterlyControlItemListResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: "#/components/schemas/QuarterlyControlItem"

    # Metrics Schemas
    Bucket:
      type: object
      properties:
        label:
          type: string
          description: Human-readable label for the bucket
          example: "0k-20k km"
        min:
          type: integer
          description: Minimum value (inclusive)
          example: 0
        max:
          type: integer
          nullable: true
          description: Maximum value (exclusive), null for "X or more" bucket
          example: 20000
        count:
          type: integer
          description: Number of items in this bucket
          example: 15

    DistributionItem:
      type: object
      properties:
        id:
          type: string
          nullable: true
          description: ID for drill-down queries (e.g., brandId)
          example: "uuid-1234"
        name:
          type: string
          description: Display name
          example: "Toyota"
        count:
          type: integer
          description: Number of items
          example: 25

    TimelineItem:
      type: object
      properties:
        month:
          type: string
          description: Month in YYYY-MM format
          example: "2025-01"
        count:
          type: integer
          description: Count for this month
          example: 45

    QuarterlyControlMetric:
      type: object
      properties:
        year:
          type: integer
          example: 2025
        quarter:
          type: integer
          minimum: 1
          maximum: 4
          example: 1
        label:
          type: string
          description: Quarter in format YYYY-QN
          example: "2025-Q1"
        total:
          type: integer
          description: Total controls in this quarter
          example: 80
        aprobados:
          type: integer
          description: Controls with all items approved
          example: 50
        pendientes:
          type: integer
          description: Controls with pending items
          example: 20
        rechazados:
          type: integer
          description: Controls with rejected items
          example: 5
        vencidos:
          type: integer
          description: Overdue controls (past intended date, not filled)
          example: 5

    PersonnelMetric:
      type: object
      properties:
        totalActual:
          type: integer
          description: Current active count
          example: 35
        timeline:
          type: array
          items:
            $ref: "#/components/schemas/TimelineItem"

    RiskSummary:
      type: object
      properties:
        key:
          type: string
          description: Machine-readable risk category key
          example: "vehicles-without-responsible"
        label:
          type: string
          description: Human-readable risk category label
          example: "Vehículos sin responsable"
        count:
          type: integer
          description: Number of items in this risk category
          example: 5
        severity:
          type: string
          enum: [low, medium, high]
          description: Risk severity level
          example: "high"

    VehicleWithoutResponsible:
      type: object
      properties:
        vehicleId:
          type: string
          format: uuid
        vehicleLicensePlate:
          type: string
          example: "ABC123"
        lastResponsibleEndDate:
          type: string
          format: date
          nullable: true

    OverdueMaintenanceItem:
      type: object
      properties:
        vehicleId:
          type: string
          format: uuid
        vehicleLicensePlate:
          type: string
          example: "ABC123"
        maintenanceId:
          type: string
          format: uuid
        maintenanceName:
          type: string
          example: "Cambio de aceite"
        dueDate:
          type: string
          format: date
          nullable: true
        dueKilometers:
          type: integer
          nullable: true
          example: 50000
        currentKilometers:
          type: integer
          example: 52000
        daysOverdue:
          type: integer
          nullable: true
          example: 30
        kilometersOverdue:
          type: integer
          nullable: true
          example: 2000

    OverdueQuarterlyControl:
      type: object
      properties:
        id:
          type: string
          format: uuid
        vehicleId:
          type: string
          format: uuid
        vehicleLicensePlate:
          type: string
          example: "ABC123"
        year:
          type: integer
          example: 2024
        quarter:
          type: integer
          minimum: 1
          maximum: 4
          example: 2
        intendedDeliveryDate:
          type: string
          format: date
        daysOverdue:
          type: integer
          example: 15

    QuarterlyControlWithErrors:
      type: object
      properties:
        id:
          type: string
          format: uuid
        vehicleId:
          type: string
          format: uuid
        vehicleLicensePlate:
          type: string
          example: "ABC123"
        year:
          type: integer
          example: 2024
        quarter:
          type: integer
          minimum: 1
          maximum: 4
          example: 2
        rejectedItemsCount:
          type: integer
          example: 3

    VehicleWithoutRecentKilometers:
      type: object
      properties:
        id:
          type: string
          format: uuid
        vehicleId:
          type: string
          format: uuid
        vehicleLicensePlate:
          type: string
          example: "ABC123"
        lastKilometerDate:
          type: string
          format: date
          nullable: true
        lastKilometers:
          type: integer
          nullable: true
          example: 45000
        daysSinceLastUpdate:
          type: integer
          description: Days since last kilometer update, -1 if never updated
          example: 45

  responses:
    # Common error responses using RFC 7807
    BadRequest:
      description: Bad Request - Invalid input data
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ValidationProblemDetails"

    Unauthorized:
      description: Unauthorized - Authentication required
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"

    NotFound:
      description: Resource not found
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"

    Forbidden:
      description: Forbidden - Insufficient permissions
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"

    Conflict:
      description: Resource already exists
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"

    InternalServerError:
      description: Internal server error
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"

    # Metrics Response Schemas
    VehicleCountResponse:
      description: Vehicle count response
      content:
        application/json:
          schema:
            type: object
            properties:
              status:
                type: string
                example: "success"
              data:
                type: object
                properties:
                  total:
                    type: integer
                    example: 80

    BucketListResponse:
      description: Bucket list response
      content:
        application/json:
          schema:
            type: object
            properties:
              status:
                type: string
                example: "success"
              data:
                type: object
                properties:
                  buckets:
                    type: array
                    items:
                      $ref: "#/components/schemas/Bucket"

    DistributionListResponse:
      description: Distribution list response
      content:
        application/json:
          schema:
            type: object
            properties:
              status:
                type: string
                example: "success"
              data:
                type: object
                properties:
                  distribution:
                    type: array
                    items:
                      $ref: "#/components/schemas/DistributionItem"

    TimelineResponse:
      description: Timeline response
      content:
        application/json:
          schema:
            type: object
            properties:
              status:
                type: string
                example: "success"
              data:
                type: object
                properties:
                  timeline:
                    type: array
                    items:
                      $ref: "#/components/schemas/TimelineItem"

    QuarterlyControlMetricsResponse:
      description: Quarterly control metrics response
      content:
        application/json:
          schema:
            type: object
            properties:
              status:
                type: string
                example: "success"
              data:
                type: object
                properties:
                  metrics:
                    type: array
                    items:
                      $ref: "#/components/schemas/QuarterlyControlMetric"

    PersonnelMetricsResponse:
      description: Personnel metrics response
      content:
        application/json:
          schema:
            type: object
            properties:
              status:
                type: string
                example: "success"
              data:
                $ref: "#/components/schemas/PersonnelMetric"

    RiskSummaryResponse:
      description: Risk indicators summary
      content:
        application/json:
          schema:
            type: object
            properties:
              status:
                type: string
                example: "success"
              data:
                type: array
                items:
                  $ref: "#/components/schemas/RiskSummary"

    VehiclesWithoutResponsibleResponse:
      description: Vehicles without current responsible
      content:
        application/json:
          schema:
            type: object
            properties:
              status:
                type: string
                example: "success"
              data:
                type: array
                items:
                  $ref: "#/components/schemas/VehicleWithoutResponsible"

    OverdueMaintenanceResponse:
      description: Overdue maintenance items
      content:
        application/json:
          schema:
            type: object
            properties:
              status:
                type: string
                example: "success"
              data:
                type: array
                items:
                  $ref: "#/components/schemas/OverdueMaintenanceItem"

    OverdueQuarterlyControlsResponse:
      description: Overdue quarterly controls
      content:
        application/json:
          schema:
            type: object
            properties:
              status:
                type: string
                example: "success"
              data:
                type: array
                items:
                  $ref: "#/components/schemas/OverdueQuarterlyControl"

    QuarterlyControlsWithErrorsResponse:
      description: Quarterly controls with rejected items
      content:
        application/json:
          schema:
            type: object
            properties:
              status:
                type: string
                example: "success"
              data:
                type: array
                items:
                  $ref: "#/components/schemas/QuarterlyControlWithErrors"

    VehiclesWithoutRecentKilometersResponse:
      description: Vehicles without recent kilometer readings
      content:
        application/json:
          schema:
            type: object
            properties:
              status:
                type: string
                example: "success"
              data:
                type: array
                items:
                  $ref: "#/components/schemas/VehicleWithoutRecentKilometers"

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    DevImpersonateKey:
      type: apiKey
      in: header
      name: x-dev-impersonate
      description: Dev-only. Email or entraId to impersonate. Requires server AUTH_BYPASS=true.
  parameters:
    PageParam:
      name: page
      in: query
      schema:
        type: integer
        minimum: 1
        default: 1
      description: Page number for pagination
    LimitParam:
      name: limit
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 10
      description: Number of items per page
    SearchParam:
      name: search
      in: query
      schema:
        type: string
      description: Search term applied across multiple fields (case-insensitive)
    SwaggerBypassHeader:
      name: x-swagger-bypass
      in: header
      required: false
      description: Dev-only header to bypass authentication in Swagger Try-It-Out when server is started with SWAGGER_BYPASS_AUTH=true.
      schema:
        type: string
        enum: ["true"]
        default: "true"
    DevImpersonateHeader:
      name: x-dev-impersonate
      in: header
      required: false
      description: Dev-only. Email or entraId of the user to impersonate (requires server AUTH_BYPASS=true).
      schema:
        type: string
        example: user@example.com

# Global security: require Bearer JWT for all endpoints unless a path/operation overrides with security: []
security:
  - BearerAuth: []
  - DevImpersonateKey: []
